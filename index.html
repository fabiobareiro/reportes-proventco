
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Provent-Co | Intelligence Hub</title>
    
    <!-- FUENTES & ICONOS -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            /* DARK THEME: "OBSIDIAN" */
            --bg-deep: #000000;
            --bg-surface: #0a0a0a;
            --bg-elevated: #111111;
            
            --border: #222222;
            --border-highlight: #333333;
            
            --text-main: #ededed;
            --text-muted: #737373;
            --text-accent: #a3a3a3;

            /* BRAND COLORS */
            --primary: #6366f1; /* Indigo NEON */
            --primary-dim: rgba(99, 102, 241, 0.1);
            --success: #22c55e; /* Green NEON */
            --success-dim: rgba(34, 197, 94, 0.1);
            --warm: #f59e0b;
            
            --font-sans: 'Plus Jakarta Sans', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        /* --- BASE --- */
        body { 
            background: var(--bg-deep); color: var(--text-main); font-family: var(--font-sans);
            margin: 0; padding: 0; -webkit-font-smoothing: antialiased;
        }
        * { box-sizing: border-box; }

        /* --- HEADER YTD (ACUMULADO) --- */
        .ytd-header {
            border-bottom: 1px solid var(--border);
            padding: 15px 30px;
            background: rgba(10, 10, 10, 0.8);
            backdrop-filter: blur(10px);
            position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
        }
        .logo-block { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 1.1rem; letter-spacing: -0.5px; }
        .ytd-stats { display: flex; gap: 30px; }
        .ytd-item { display: flex; flex-direction: column; align-items: flex-end; }
        .ytd-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }
        .ytd-val { font-family: var(--font-mono); font-weight: 600; color: var(--text-main); font-size: 0.95rem; }

        /* --- CONTENEDOR PRINCIPAL --- */
        .dashboard-container { max-width: 1400px; margin: 0 auto; padding: 30px; display: grid; grid-template-columns: repeat(12, 1fr); gap: 20px; }

        /* --- CARDS & TITLES --- */
        .card { background: var(--bg-surface); border: 1px solid var(--border); border-radius: 16px; padding: 24px; position: relative; overflow: hidden; display: flex; flex-direction: column; transition: border 0.3s; }
        .card:hover { border-color: var(--border-highlight); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card-title { font-size: 0.9rem; font-weight: 600; color: var(--text-accent); display: flex; align-items: center; gap: 8px; }
        
        /* --- 1. HERO ROI (Big Block) --- */
        .hero-section { grid-column: span 8; background: linear-gradient(145deg, var(--bg-surface), #0e0e11); }
        .roi-display { display: flex; align-items: baseline; gap: 15px; margin-top: 10px; }
        .roi-number { font-family: var(--font-mono); font-size: 4.5rem; font-weight: 700; line-height: 0.9; color: #fff; letter-spacing: -2px; }
        .roi-currency { font-size: 2rem; color: var(--text-muted); }
        .pill { background: var(--bg-elevated); border: 1px solid var(--border); padding: 6px 12px; border-radius: 99px; font-size: 0.8rem; color: var(--text-accent); display: flex; align-items: center; gap: 6px; }
        .pill.active { border-color: var(--primary); color: var(--primary); background: var(--primary-dim); }

        /* --- 2. KPIS COMPARATIVOS --- */
        .kpi-mini { grid-column: span 2; }
        .kpi-val { font-size: 2.2rem; font-weight: 700; margin: 10px 0 5px 0; font-family: var(--font-mono); }
        .kpi-delta { font-size: 0.8rem; display: flex; align-items: center; gap: 4px; font-weight: 500; }
        .kpi-delta.pos { color: var(--success); }
        .kpi-delta.neg { color: var(--warm); }
        .kpi-delta.neutral { color: var(--text-muted); }

        /* --- 3. ANALISIS IA (INFORME) --- */
        .ai-report-card { grid-column: span 12; border: 1px solid #333; background: linear-gradient(to bottom, #111, #0a0a0a); }
        .ai-header-badge { background: linear-gradient(135deg, #6366f1, #a855f7); color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; }
        .ai-content { 
            font-family: 'Inter', sans-serif; 
            color: #d4d4d8; line-height: 1.7; font-size: 1rem; 
            border-left: 2px solid var(--primary); padding-left: 20px; margin-left: 5px;
            white-space: pre-line; /* Respetar saltos de línea del LLM */
        }
        .ai-content strong { color: #fff; font-weight: 600; }

        /* --- 4. GRÁFICO DINÁMICO (Zonas/Servicios) --- */
        .chart-dynamic { grid-column: span 8; height: 420px; }
        .toggle-group { display: flex; background: var(--bg-elevated); border-radius: 8px; padding: 3px; border: 1px solid var(--border); }
        .toggle-btn { 
            padding: 6px 12px; font-size: 0.75rem; color: var(--text-muted); cursor: pointer; border-radius: 5px; transition: 0.2s; 
        }
        .toggle-btn:hover { color: #fff; }
        .toggle-btn.selected { background: #262626; color: #fff; font-weight: 600; box-shadow: 0 1px 3px rgba(0,0,0,0.5); }

        /* --- 5. FUENTES (Dona) --- */
        .chart-sources { grid-column: span 4; height: 420px; }
        
        /* --- 6. TIMELINE --- */
        .chart-timeline { grid-column: span 12; height: 300px; }

        /* RESPONSIVE */
        @media (max-width: 1024px) { 
            .hero-section { grid-column: span 12; }
            .kpi-mini { grid-column: span 6; }
            .chart-dynamic, .chart-sources { grid-column: span 12; }
            .ytd-stats { display: none; } /* Ocultar stats anuales en movil pequeño si molesta */
        }

    </style>
</head>
<body>

    <!-- NAV SUPERIOR: TOTALES ANUALES (YTD) -->
    <header class="ytd-header">
        <div class="logo-block">
            <i data-lucide="cpu" size="20" style="color: var(--primary);"></i>
            <span>Provent-Co AI</span>
        </div>
        
        <div class="ytd-stats">
            <div class="ytd-item">
                <span class="ytd-label">Leads Anuales (YTD)</span>
                <span class="ytd-val" id="ytdLeads">0</span>
            </div>
            <div class="ytd-item">
                <span class="ytd-label">Ahorro Acumulado</span>
                <span class="ytd-val" style="color: var(--success);" id="ytdMoney">$0</span>
            </div>
        </div>

        <!-- SELECTOR DE MES -->
        <select id="monthSelector" onchange="renderDashboard(this.value)" style="background: var(--bg-elevated); color: white; border: 1px solid var(--border); padding: 8px 12px; border-radius: 8px;">
            <!-- JS lo llena -->
        </select>
    </header>

    <div class="dashboard-container">

        <!-- 1. HERO CARD (ROI) -->
        <div class="card hero-section">
            <div class="card-header">
                <div class="card-title">AHORRO OPERATIVO NETO</div>
                <div class="pill active"><i data-lucide="zap" size="12"></i> 100% Automático</div>
            </div>
            <div class="roi-display">
                <div class="roi-currency">$</div>
                <div class="roi-number" id="roiValue">0.00</div>
            </div>
            <div style="display: flex; gap: 15px; margin-top: 15px;">
                <div class="pill"><i data-lucide="clock" size="14"></i> <span id="hoursValue">0</span>hs humanas</div>
                <div class="pill"><i data-lucide="server" size="14"></i> <span id="interactionsValue">0</span> interacciones</div>
            </div>
        </div>

        <!-- 2. KPIs COMPARATIVOS -->
        <div class="card kpi-mini">
            <div class="card-title">Leads Totales</div>
            <div class="kpi-val" id="leadsVal">0</div>
            <div class="kpi-delta" id="leadsDelta">...</div>
        </div>

        <div class="card kpi-mini" style="border-color: rgba(34, 197, 94, 0.2);">
            <div class="card-title" style="color: var(--success);">Calificados</div>
            <div class="kpi-val" style="color: var(--success);" id="qualifiedVal">0</div>
            <div class="kpi-delta" id="qualifiedRate">0% Conv.</div>
        </div>

        <!-- 3. AI REPORT -->
        <div class="card ai-report-card">
            <div class="card-header" style="border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 15px; margin-bottom: 15px;">
                <div class="card-title" style="color: #fff;">
                    <div class="ai-header-badge">AI ANALYST</div>
                    INFORME EJECUTIVO DE RENDIMIENTO
                </div>
            </div>
            <div class="ai-content" id="aiReportText">
                Cargando análisis de inteligencia artificial...
            </div>
        </div>

        <!-- 4. GRAFICO ZONA / SERVICIO -->
        <div class="card chart-dynamic">
            <div class="card-header">
                <div class="card-title">Desglose de Demanda</div>
                <div class="toggle-group">
                    <div class="toggle-btn selected" id="btnZone" onclick="setChartMode('zone')">Por Zona</div>
                    <div class="toggle-btn" id="btnService" onclick="setChartMode('service')">Por Servicio</div>
                </div>
            </div>
            <div style="position: relative; height: 100%; width: 100%;">
                <canvas id="breakdownChart"></canvas>
            </div>
        </div>

        <!-- 5. DONA -->
        <div class="card chart-sources">
            <div class="card-header"><div class="card-title">Canal de Adquisición</div></div>
            <div style="position: relative; height: 100%; width: 100%; display: flex; align-items: center; justify-content: center;">
                <canvas id="sourceChart"></canvas>
            </div>
        </div>

        <!-- 6. TIMELINE -->
        <div class="card chart-timeline">
            <div class="card-header"><div class="card-title">Evolución Diaria (Actividad)</div></div>
            <div style="position: relative; height: 100%; width: 100%;">
                <canvas id="timelineChart"></canvas>
            </div>
        </div>

    </div>

    <!-- LOGICA DE DATOS -->
    <script>
        lucide.createIcons();

        // 1. RECIBIR DATOS DESDE N8N
        // Inyectamos la variable que preparamos arriba
        const HISTORY = [{"id":11,"created_at":"2025-12-26T18:19:46.082472-03:00","month":12,"year":2025,"company_name":"Provent-Co","stats_data":{"roi":{"hours_saved":147,"money_saved_usd":"918.75"},"kpis":{"followups":79,"heavy_users":49,"total_leads":151,"interactions":582,"qualified_leads":27},"meta":{"year":2025,"company":"Provent-Co","month_name":"Diciembre","generated_at":"2025-12-26T21:19:43.883Z"},"charts":{"sales":{"data":[1,26],"labels":["Si","Sin definir"]},"sources":{"data":[93,58],"labels":["anuncio","organico"]},"services":{"data":[7,4,8,7,1],"labels":["Piso Radiante","Aire Acondicionado","Otros","Radiadores","Calderas"]},"timeline":{"data":[7,8,10,3,2,10,9,8,12,3,7,12,17,8,9,4,6,3,7,5,1],"labels":["4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24"]},"locations":{"data":[1,1,4,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,1,1],"labels":["Fernandez oro","Villa florencia, neuquén capital","Allen","Neuquén, calle conquistadores del desierto al 2400","Bocahue, neuquén","General roca, río negro","Neuquén capital - barrio la peregrina","Neuquén capital, barrio costa nogal","Barrio belgrano, saturnino torres casi boerr, neuquén capital","Neuquén capital, barrio confluencia sector rural","Neuquén, barrio naciones unidas","Neuquén capital","Plottier, barrio castro rendón","Canales de plottier","Plottier, loteo las gemmas","Cipolletti","Límite plottier - neuquén, barrio finca laguna blanca","Neuquen capital, barrio maronese","Valentina sur, neuquén","Parque industrial","Fernández oro","Plottier - loteo peumayen manzana k lote 03 (colonia san francisco)","La herradura, plotier"]}},"ai_analysis":"En diciembre, la IA ahorró $918.75 USD gestionando 151 leads; destaca el fuerte interés en Piso Radiante, especialmente en Neuquén capital, con una conversión del 18% a leads calificados y 49 usuarios muy activos que impulsan oportunidades en la zona."}}]; 
        
        let currentMonthData = null;
        let chartInstance = null; // Para destruir/recrear el principal
        let viewMode = 'zone'; // 'zone' or 'service'

        // 2. CALCULAR TOTALES YTD (ACUMULADOS ANUALES)
        function calculateYTD() {
            // Asumimos año actual del último reporte
            if(HISTORY.length === 0) return;
            const currentYear = HISTORY[HISTORY.length-1].year;
            
            const reportsThisYear = HISTORY.filter(h => h.year === currentYear);
            
            const totalLeads = reportsThisYear.reduce((acc, curr) => acc + (curr.stats_data.kpis.total_leads || 0), 0);
            const totalMoney = reportsThisYear.reduce((acc, curr) => acc + parseFloat(curr.stats_data.roi.money_saved_usd || 0), 0);

            document.getElementById('ytdLeads').innerText = totalLeads;
            document.getElementById('ytdMoney').innerText = '$' + totalMoney.toLocaleString('en-US', {minimumFractionDigits: 0});
        }

        // 3. INICIALIZAR SELECTOR
        const selector = document.getElementById('monthSelector');
        // Iteramos INVERSO para tener el más reciente arriba
        [...HISTORY].reverse().forEach((h, index) => {
            // El índice original en HISTORY es lo que necesitamos (length - 1 - index)
            const realIndex = HISTORY.indexOf(h);
            const opt = document.createElement('option');
            opt.value = realIndex;
            opt.text = h.stats_data.meta.month_name + ' ' + h.year;
            selector.appendChild(opt);
        });

        // 4. RENDER DASHBOARD (Función Maestra)
        function renderDashboard(index) {
            const report = HISTORY[index];
            currentMonthData = report.stats_data; // Shortcut al JSON
            
            // --- A. TEXTOS Y KPIS ---
            // Animar números simple
            document.getElementById('roiValue').innerText = currentMonthData.roi.money_saved_usd;
            document.getElementById('hoursValue').innerText = currentMonthData.roi.hours_saved;
            document.getElementById('interactionsValue').innerText = currentMonthData.kpis.interactions;

            document.getElementById('leadsVal').innerText = currentMonthData.kpis.total_leads;
            document.getElementById('qualifiedVal').innerText = currentMonthData.kpis.qualified_leads;
            
            // Texto IA (Con formato bold si lo hubiera)
            document.getElementById('aiReportText').innerHTML = (report.ai_analysis || "No hay análisis disponible.").replace(/**(.*?)**/g, '<strong>$1</strong>');

            // --- B. COMPARATIVA MES ANTERIOR ---
            if(index > 0) {
                const prevReport = HISTORY[index - 1].stats_data;
                const prevLeads = prevReport.kpis.total_leads || 0;
                const currLeads = currentMonthData.kpis.total_leads || 0;
                
                let diff = 0;
                let text = "vs inicio";
                
                if (prevLeads > 0) {
                    diff = ((currLeads - prevLeads) / prevLeads) * 100;
                    text = diff > 0 ? `+${diff.toFixed(1)}% vs mes ant.` : `${diff.toFixed(1)}% vs mes ant.`;
                }

                const el = document.getElementById('leadsDelta');
                el.innerText = text;
                el.className = 'kpi-delta ' + (diff >= 0 ? 'pos' : 'neg');
            } else {
                document.getElementById('leadsDelta').innerText = "Inicio de ciclo";
                document.getElementById('leadsDelta').className = 'kpi-delta neutral';
            }

            // Tasa Conversion
            const rate = currentMonthData.kpis.total_leads > 0 
                ? ((currentMonthData.kpis.qualified_leads / currentMonthData.kpis.total_leads)*100).toFixed(1) 
                : 0;
            document.getElementById('qualifiedRate').innerText = rate + "% Conversión";

            // --- C. RENDERIZAR GRÁFICOS ---
            renderMainChart();
            renderSourceChart();
            renderTimelineChart();
        }

        // --- CHART 1: ZONA vs SERVICIO (Swappable) ---
        function setChartMode(mode) {
            viewMode = mode;
            // Update buttons
            document.getElementById('btnZone').className = mode === 'zone' ? 'toggle-btn selected' : 'toggle-btn';
            document.getElementById('btnService').className = mode === 'service' ? 'toggle-btn selected' : 'toggle-btn';
            renderMainChart();
        }

        function renderMainChart() {
            // Destruir si existe para evitar glitch
            if(chartInstance) chartInstance.destroy();
            
            const ctx = document.getElementById('breakdownChart').getContext('2d');
            const data = currentMonthData.charts; // { locations: {labels, data}, services: {labels, data} }

            // Elegir datos según modo
            const labels = viewMode === 'zone' ? data.locations.labels : data.services.labels;
            const values = viewMode === 'zone' ? data.locations.data : data.services.data;
            const color = viewMode === 'zone' ? '#6366f1' : '#f59e0b';
            const labelTitle = viewMode === 'zone' ? 'Leads por Zona' : 'Leads por Servicio';

            chartInstance = new Chart(ctx, {
                type: 'bar', // Barra Horizontal es mejor para leer nombres largos
                data: {
                    labels: labels,
                    datasets: [{
                        label: labelTitle,
                        data: values,
                        backgroundColor: color,
                        borderRadius: 6,
                        barPercentage: 0.6
                    }]
                },
                options: {
                    indexAxis: 'y', // SIEMPRE HORIZONTAL para leer bien nombres como "Piso Radiante"
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { grid: { color: '#333', borderDash: [4,4] } },
                        y: { grid: { display: false } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- CHART 2: SOURCES (Dona) ---
        function renderSourceChart() {
            // Destruir por ID si hace falta (simple way)
            const chartStatus = Chart.getChart("sourceChart"); 
            if (chartStatus != undefined) chartStatus.destroy();

            const ctx = document.getElementById('sourceChart');
            const sData = currentMonthData.charts.sources;
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sData.labels,
                    datasets: [{
                        data: sData.data,
                        backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ec4899', '#3b82f6'],
                        borderWidth: 0,
                        hoverOffset: 15
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: { 
                        legend: { position: 'bottom', labels: { color: '#a3a3a3', usePointStyle: true } } 
                    }
                }
            });
        }

        // --- CHART 3: TIMELINE (Line) ---
        function renderTimelineChart() {
            const chartStatus = Chart.getChart("timelineChart"); 
            if (chartStatus != undefined) chartStatus.destroy();

            const ctx = document.getElementById('timelineChart').getContext('2d');
            const tData = currentMonthData.charts.timeline;

            // Gradiente
            const grad = ctx.createLinearGradient(0,0,0,400);
            grad.addColorStop(0, 'rgba(99, 102, 241, 0.5)');
            grad.addColorStop(1, 'rgba(99, 102, 241, 0.0)');

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: tData.labels.map(d => 'Día '+d), // Formatear labels
                    datasets: [{
                        label: 'Leads Diarios',
                        data: tData.data,
                        borderColor: '#6366f1',
                        backgroundColor: grad,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#222' } },
                        x: { grid: { display: false }, ticks: { color: '#555' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // GLOBALS CHART CONFIG
        Chart.defaults.color = '#737373';
        Chart.defaults.borderColor = '#222';
        Chart.defaults.font.family = "'Plus Jakarta Sans', sans-serif";

        // INICIAR
        calculateYTD();
        // Cargar el ultimo reporte disponible
        if(HISTORY.length > 0) {
            renderDashboard(HISTORY.length - 1);
            // Preseleccionar en dropdown
            selector.value = HISTORY.length - 1;
        } else {
            document.body.innerHTML = "<h1 style='color:white; text-align:center; margin-top:50px;'>No hay datos históricos aún.</h1>";
        }

    </script>
</body>
</html>
